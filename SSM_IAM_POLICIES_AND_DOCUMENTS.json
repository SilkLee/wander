{
  "iam_policies": {
    "AmazonSSMManagedInstanceCore": {
      "description": "AWS managed policy - minimal permissions for EC2 SSM management",
      "arn": "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore",
      "when_to_use": "Standard choice for EC2 instances using SSM",
      "includes": [
        "ssmmessages:CreateControlChannel",
        "ssmmessages:CreateDataChannel",
        "ssmmessages:OpenControlChannel",
        "ssmmessages:OpenDataChannel",
        "ec2messages:AcknowledgeMessage",
        "ec2messages:DeleteMessage",
        "ec2messages:FailMessage",
        "ec2messages:GetEndpoint",
        "ec2messages:GetMessages",
        "ssm:UpdateInstanceInformation",
        "ssmmessages:OpenExecSession",
        "ssmmessages:CreateExecSession"
      ]
    }
  },

  "custom_iam_policies": {
    "minimal_ssm_session_manager": {
      "description": "Minimal custom policy for Session Manager only",
      "use_case": "EC2 instances that ONLY use Session Manager, no Run Command",
      "policy": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "SSMSessionManagerOnly",
            "Effect": "Allow",
            "Action": [
              "ssmmessages:CreateControlChannel",
              "ssmmessages:CreateDataChannel",
              "ssmmessages:OpenControlChannel",
              "ssmmessages:OpenDataChannel"
            ],
            "Resource": "*"
          }
        ]
      }
    },

    "minimal_ssm_send_command": {
      "description": "Minimal custom policy for Run Command only",
      "use_case": "EC2 instances that ONLY use Run Command, no interactive sessions",
      "policy": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "SSMRunCommandOnly",
            "Effect": "Allow",
            "Action": [
              "ssmmessages:CreateDataChannel",
              "ssmmessages:OpenDataChannel",
              "ec2messages:AcknowledgeMessage",
              "ec2messages:DeleteMessage",
              "ec2messages:FailMessage",
              "ec2messages:GetMessages",
              "ssm:UpdateInstanceInformation"
            ],
            "Resource": "*"
          }
        ]
      }
    },

    "ssm_with_s3_output": {
      "description": "SSM with S3 output bucket access",
      "use_case": "When using --output-s3-bucket-name for command results",
      "policy": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "SSMCore",
            "Effect": "Allow",
            "Action": [
              "ssmmessages:CreateControlChannel",
              "ssmmessages:CreateDataChannel",
              "ssmmessages:OpenControlChannel",
              "ssmmessages:OpenDataChannel",
              "ec2messages:AcknowledgeMessage",
              "ec2messages:DeleteMessage",
              "ec2messages:FailMessage",
              "ec2messages:GetMessages",
              "ssm:UpdateInstanceInformation"
            ],
            "Resource": "*"
          },
          {
            "Sid": "S3OutputBucket",
            "Effect": "Allow",
            "Action": [
              "s3:PutObject",
              "s3:GetObject"
            ],
            "Resource": "arn:aws:s3:::ssm-output-bucket/*"
          }
        ]
      }
    },

    "ssm_user_limited_access": {
      "description": "IAM policy for end-users to start sessions",
      "use_case": "Attach to IAM users who need to use SSM",
      "policy": {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "StartSession",
            "Effect": "Allow",
            "Action": "ssm:StartSession",
            "Resource": "arn:aws:ec2:*:ACCOUNT_ID:instance/*",
            "Condition": {
              "StringEquals": {
                "aws:RequestedRegion": "us-east-1"
              },
              "StringLike": {
                "aws:userid": "*:my-role-session-name"
              }
            }
          },
          {
            "Sid": "SendCommand",
            "Effect": "Allow",
            "Action": [
              "ssm:SendCommand",
              "ssm:GetCommandInvocation"
            ],
            "Resource": [
              "arn:aws:ec2:*:ACCOUNT_ID:instance/*",
              "arn:aws:ssm:*:ACCOUNT_ID:document/AWS-RunShellScript"
            ]
          },
          {
            "Sid": "ListInstances",
            "Effect": "Allow",
            "Action": "ssm:DescribeInstanceInformation",
            "Resource": "*"
          }
        ]
      }
    }
  },

  "trust_policy_for_ec2_role": {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "Service": "ec2.amazonaws.com"
        },
        "Action": "sts:AssumeRole"
      }
    ]
  },

  "ssm_documents": {
    "AWS-RunShellScript": {
      "type": "Command",
      "description": "Built-in document for running shell scripts on Linux",
      "parameters": {
        "commands": {
          "description": "Array of shell commands to execute",
          "type": "StringList",
          "example": ["echo Hello", "ls -la", "df -h"]
        },
        "workingDirectory": {
          "type": "String",
          "default": "~",
          "example": "/tmp"
        }
      },
      "cli_example": "aws ssm send-command --document-name AWS-RunShellScript --parameters 'commands=[\"echo test\"]' --instance-ids i-xxx"
    },

    "AWS-RunPowerShellScript": {
      "type": "Command",
      "description": "Built-in document for running PowerShell scripts on Windows",
      "parameters": {
        "command": {
          "description": "PowerShell script content",
          "type": "String"
        }
      },
      "cli_example": "aws ssm send-command --document-name AWS-RunPowerShellScript --parameters 'command=\"Get-Process\"' --instance-ids i-xxx"
    },

    "AWS-ConfigureAWSPackage": {
      "type": "Command",
      "description": "Install/update AWS or third-party packages"
    },

    "AWS-RunPatchBaseline": {
      "type": "Command",
      "description": "Apply patch baselines to instances"
    }
  },

  "command_examples": {
    "send_command_single_command": {
      "description": "Run single shell command",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-1234567890abcdef0 --parameters 'commands=[\"echo HelloWorld\"]'",
      "expected_output": {
        "Command": {
          "CommandId": "92853adf-ba41-4cd6-9a88-142d1EXAMPLE",
          "DocumentName": "AWS-RunShellScript",
          "Status": "Pending"
        }
      }
    },

    "send_command_multiple_commands": {
      "description": "Run multiple commands sequentially",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"cd /tmp\",\"mkdir mydir\",\"ls -la\"]'",
      "note": "Commands execute in order; if one fails, subsequent commands still run"
    },

    "send_command_to_tagged_instances": {
      "description": "Run command on all instances with specific tag",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --targets 'Key=tag:Environment,Values=Production' --parameters 'commands=[\"systemctl restart nginx\"]'",
      "note": "Can target tens, hundreds, or thousands of instances"
    },

    "send_command_to_multiple_tagged_instances": {
      "description": "Run command on instances matching multiple tag filters",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --targets Key=tag:Environment,Values=Production Key=tag:Role,Values=WebServer --parameters 'commands=[\"systemctl status nginx\"]'",
      "note": "Both conditions must match (AND logic)"
    },

    "send_command_with_s3_output": {
      "description": "Capture command output to S3",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"curl https://example.com\"]' --output-s3-bucket-name my-bucket --output-s3-key-prefix commands/",
      "result_location": "s3://my-bucket/commands/CommandId/InstanceId/aws:runShellScript/0.standard.out"
    },

    "send_command_with_cloudwatch_logs": {
      "description": "Stream command output to CloudWatch Logs",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"tail -f /var/log/syslog\"]' --cloud-watch-output-config CloudWatchLogGroupName=/aws/ssm/commands,CloudWatchOutputEnabled=true",
      "log_group": "/aws/ssm/commands"
    },

    "send_command_with_concurrency_control": {
      "description": "Control concurrent execution across instances",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --targets 'Key=tag:Env,Values=Prod' --parameters 'commands=[\"apt update\",\"apt upgrade -y\"]' --max-concurrency '10%' --max-errors '0'",
      "note": "max-concurrency='10%' runs on 10% of targets at a time. max-errors='0' stops if any fail"
    },

    "get_command_invocation": {
      "description": "Check status and get output of specific command invocation",
      "command": "aws ssm get-command-invocation --command-id abc123 --instance-id i-xxx",
      "output_fields": [
        "CommandId",
        "InstanceId",
        "Status (Pending|InProgress|Success|Failed|Cancelled|TimedOut)",
        "StandardOutputContent (first 24000 chars)",
        "StandardErrorContent (first 8000 chars)",
        "ExecutionStartDateTime",
        "ExecutionElapsedTime"
      ]
    },

    "list_command_invocations": {
      "description": "List all invocations of a command across instances",
      "command": "aws ssm list-command-invocations --command-id abc123 --details",
      "note": "Use --details flag to see StandardOutputContent inline"
    },

    "describe_instance_information": {
      "description": "List all instances managed by SSM",
      "command": "aws ssm describe-instance-information --query 'InstanceInformationList[*].[InstanceId,PingStatus,PlatformType]' --output table",
      "filter_examples": [
        "aws ssm describe-instance-information --filters Key=InstanceIds,Values=i-xxx i-yyy",
        "aws ssm describe-instance-information --filters Key=tag:Environment,Values=Production"
      ]
    },

    "start_session": {
      "description": "Start interactive Session Manager session",
      "command": "aws ssm start-session --target i-1234567890abcdef0",
      "note": "Requires session-manager-plugin installed locally"
    },

    "start_session_with_command": {
      "description": "Start session and run single command (non-interactive)",
      "command": "aws ssm start-session --target i-xxx --document-name AWS-RunShellScript --parameters 'command=[\"echo Hello\"]'",
      "note": "Exits after command completes"
    }
  },

  "output_parsing_examples": {
    "extract_command_id": {
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"echo test\"]' --query 'Command.CommandId' --output text",
      "result": "abc123def456"
    },

    "extract_command_status": {
      "command": "aws ssm get-command-invocation --command-id abc123 --instance-id i-xxx --query 'Status' --output text",
      "result": "Success"
    },

    "extract_standard_output": {
      "command": "aws ssm get-command-invocation --command-id abc123 --instance-id i-xxx --query 'StandardOutputContent' --output text",
      "result": "stdout content here"
    },

    "list_online_instances": {
      "command": "aws ssm describe-instance-information --filters 'Key=PingStatus,Values=Online' --query 'InstanceInformationList[*].InstanceId' --output text",
      "result": "i-111 i-222 i-333"
    }
  },

  "bash_utility_functions": {
    "parse_json_safely": "result=$(jq -r '.field' <<< \"$json_string\") || echo \"Parse error\"",
    "check_command_status": "status=$(aws ssm get-command-invocation --command-id $CMD_ID --instance-id $INST_ID --query Status --output text)",
    "wait_with_timeout": "elapsed=0; while [ $elapsed -lt 300 ]; do status=$(get_status); [ \"$status\" = \"Success\" ] && break; sleep 5; elapsed=$((elapsed+5)); done",
    "batch_instances": "for id in i-111 i-222 i-333; do aws ssm send-command --instance-ids $id --document-name AWS-RunShellScript --parameters 'commands=[\"cmd\"]'; done"
  },

  "testing_scenarios": {
    "verify_basic_connectivity": {
      "description": "Test if SSM Agent is responding",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"echo SSM is working\"]'",
      "success_indicator": "Command status changes from Pending to Success"
    },

    "test_environment_variables": {
      "description": "Verify environment inside command execution",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"env\",\"whoami\",\"pwd\"]'",
      "expected_user": "root or ec2-user depending on OS"
    },

    "test_file_creation": {
      "description": "Verify write permissions",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"echo test > /tmp/test.txt\",\"cat /tmp/test.txt\"]'",
      "expected_output": "test"
    },

    "test_network_access": {
      "description": "Verify outbound connectivity",
      "command": "aws ssm send-command --document-name AWS-RunShellScript --instance-ids i-xxx --parameters 'commands=[\"curl -I https://aws.amazon.com\"]'",
      "expected_output": "HTTP/1.1 200"
    }
  },

  "troubleshooting_reference": {
    "instance_not_in_ssm": {
      "possible_causes": [
        "IAM role not attached to instance",
        "IAM role missing SSM permissions",
        "SSM Agent not running",
        "Security group blocking outbound 443",
        "VPC endpoint misconfigured",
        "Instance not started yet (wait 2-3 minutes)"
      ],
      "debug_commands": [
        "aws ec2 describe-instances --instance-ids i-xxx --query 'Reservations[0].Instances[0].IamInstanceProfile'",
        "aws ssm describe-instance-information --filters Key=InstanceIds,Values=i-xxx",
        "ssh into instance: sudo systemctl status amazon-ssm-agent",
        "ssh into instance: curl -I https://ssmmessages.us-east-1.amazonaws.com"
      ]
    },

    "command_fails_with_status_failed": {
      "steps": [
        "Check StandardErrorContent: aws ssm get-command-invocation --command-id X --instance-id i-xxx",
        "Verify command syntax (shells may differ between Linux/Windows)",
        "Try simpler command first: echo 'test'",
        "Check if command requires sudo (SSM runs as root by default on Linux)"
      ]
    },

    "command_hangs_with_status_inprogress": {
      "steps": [
        "Check if command is waiting for input",
        "Verify --timeout-seconds if set",
        "Look at CloudWatch logs if configured",
        "Check S3 output bucket if configured (may be in progress)"
      ]
    }
  }
}
